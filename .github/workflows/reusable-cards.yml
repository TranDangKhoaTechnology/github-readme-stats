name: Build README cards (reusable)

on:
  workflow_call:
    inputs:
      username:
        type: string
        required: false
        default: ""
      theme_dark:
        type: string
        required: false
        default: "tokyonight"
      theme_light:
        type: string
        required: false
        default: "solarized-light"
      include_hero:
        type: boolean
        required: false
        default: true
    secrets:
      token:
        required: true

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1) checkout repo của NGƯỜI GỌI (repo sẽ nhận generated/*)
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.token }}

      # 2) checkout repo generator của BẠN (nơi chứa scripts) vào ./generator
      - name: Checkout generator repo
        uses: actions/checkout@v4
        with:
          repository: <YOUR_OWNER>/<YOUR_GENERATOR_REPO>
          ref: main
          path: generator

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Nếu generator có package-lock thì cài deps
      - name: Install deps (if any)
        if: ${{ hashFiles('generator/package-lock.json') != '' }}
        run: |
          cd generator
          npm ci

      - name: Generate cards
        env:
          GITHUB_TOKEN: ${{ secrets.token }}
          USERNAME: ${{ inputs.username }}
        run: |
          set -e
          U="$USERNAME"
          if [ -z "$U" ]; then
            U="${GITHUB_REPOSITORY_OWNER}"
          fi

          mkdir -p generated generated/pins

          # stats
          node generator/scripts/stats.mjs \
            --username "$U" \
            --theme "${{ inputs.theme_dark }}" \
            --out generated/stats.dark.svg

          node generator/scripts/stats.mjs \
            --username "$U" \
            --theme "${{ inputs.theme_light }}" \
            --out generated/stats.light.svg

          # top langs
          node generator/scripts/top-langs.mjs \
            --username "$U" \
            --theme "${{ inputs.theme_dark }}" \
            --out generated/top-langs.dark.svg

          node generator/scripts/top-langs.mjs \
            --username "$U" \
            --theme "${{ inputs.theme_light }}" \
            --out generated/top-langs.light.svg

          # pins auto
          node generator/scripts/pins-auto.mjs \
            --owner "$U" \
            --out_dir generated/pins \
            --theme_dark "${{ inputs.theme_dark }}" \
            --theme_light "${{ inputs.theme_light }}" \
            --include_forks false \
            --sort updated

          # hero (nếu có script marketing.mjs)
          if [ "${{ inputs.include_hero }}" = "true" ] && [ -f generator/scripts/marketing.mjs ]; then
            node generator/scripts/marketing.mjs \
              --style clean \
              --out generated/hero.dark.svg \
              --title "$U" \
              --tagline "Automation • Web Apps • AI" \
              --desc "I build automation, landing pages, and chatbots to help grow your business." \
              --badges "Open for freelance,Remote,Fast delivery" \
              --points "Automation workflows,Landing page SEO + Analytics,Chatbot + API integration" \
              --stats "Projects|25+,Response|<24h,Clients|10+" \
              --cta_text "Contact me" \
              --cta_url "https://github.com/$U"

            node generator/scripts/marketing.mjs \
              --style cleanlight \
              --out generated/hero.light.svg \
              --title "$U" \
              --tagline "Automation • Web Apps • AI" \
              --desc "I build automation, landing pages, and chatbots to help grow your business." \
              --badges "Open for freelance,Remote,Fast delivery" \
              --points "Automation workflows,Landing page SEO + Analytics,Chatbot + API integration" \
              --stats "Projects|25+,Response|<24h,Clients|10+" \
              --cta_text "Contact me" \
              --cta_url "https://github.com/$U"
          fi

      - name: Commit & push generated
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add generated
          git diff --cached --quiet || git commit -m "chore: update README cards"
          git push
